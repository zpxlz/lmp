# kvm vcpu

## 概述

kvm watcher中的kvm vcpu子功能模块是设计用于监控和分析虚拟化环境中虚拟 CPU (VCPU) 活动的工具，它通过精确记录 VCPU 的唤醒/挂起事件、halt poll 时间的变化，虚拟cpu进调度和出调度的时间记录，以及 KVM 虚拟机在热迁移过程中产生的脏页信息，为优化虚拟机性能、提高系统响应速度、提供数据支持。

## 原理介绍

### wakeup、暂停轮询

![kvm vcpu](https://gitee.com/nan-shuaibo/image/raw/master/202404251709557.png)

KVM 暂停轮询系统是 KVM 内的一项功能，其在某些情况下可以通过在vCPU 放弃运行并让出后，在主机中进行一段时间的轮询来降低虚拟机的延迟。简而言之，当vCPU 放弃运行（即执行 cede 操作）或在 PowerPC 中，当一个虚拟核心（vcore）的所有vCPU 都放弃运行时，主机内核会在将 CPU 让给调度程序之前，通过轮询等待唤醒条件。

轮询在某些情况下提供了延迟优势，尤其是在虚拟机可以非常快速地再次运行的情况下。这至少可以通过减少通过调度程序的开销来节省一些时间，通常在几微秒的数量级上，尽管性能优势取决于工作负载。在轮询间隔内，如果没有唤醒源到达，或者运行队列上有其他可运行的任务，则会调用调度程序。因此，在具有非常短唤醒周期的工作负载中，halt轮询特别有用，因为最小化了halt轮询的时间，同时可以避免调用调度程序的时间花费。 

具体的源码流程及详细原理可以参考：[内核虚拟化：vCPU之暂停轮询系统](https://blog.csdn.net/weixin_46324627/article/details/135342622?spm=1001.2014.3001.5501)

### dirty page

![dirty page](https://gitee.com/nan-shuaibo/image/raw/master/202404251709559.png)

在虚拟化环境中，脏页指的是自上次同步以来已经被修改的内存页。特别是在虚拟机热迁移过程中，源虚拟机上的内存页在复制到目标虚拟机的同时仍然处于活动状态，任何在此过程中对这些页的修改都会导致脏页的产生。监控这些脏页对于优化热迁移过程至关重要，因为过多的脏页生成可能会导致迁移延迟，甚至影响到虚拟机的运行性能。此监控功能特别适用于虚拟机热迁移的场景，其中脏页的精确监控和管理可以显著优化迁移过程。

### load_vcpu

加载虚拟 CPU（vCPU）是虚拟化环境中的一个重要步骤，它涉及为虚拟机创建和配置虚拟 CPU 实例，并将其加载到虚拟化平台中的运行环境中。加载 vCPU 将为客户机提供计算资源，允许其执行操作系统和应用程序代码。每个 vCPU 实例代表了一个独立的处理器核心，可以并行执行客户机指令。虚拟化环境中的多个 vCPU 可以并发执行客户机代码，从而支持虚拟机中的多任务和并发执行。加载多个 vCPU 允许虚拟机同时运行多个线程或进程。通过合理地分配物理资源并加载 vCPU，KVM可以优化虚拟机的性能和资源利用率。
## 挂载点

### wakeup

| 类型       | 名称            |
| :--------- | :-------------- |
| fentry     | kvm_vcpu_halt   |
| tracepoint | kvm_vcpu_wakeup |

### 暂停轮询

| 类型       | 名称             |
| :--------- | :--------------- |
| tracepoint | kvm_halt_poll_ns |

### dirty page

| 类型   | 名称                    |
| :----- | :---------------------- |
| kprobe | mark_page_dirty_in_slot |

### load_vcpu

| 类型   | 名称                    |
| :----- | :----------------------|
| kprobe | vmx_vcpu_load          |
| kprobe | vmx_vcpu_put           |
## 示例输出

### wakeup

```
#sudo ./kvm_watcher -w
TIME(ms)           DUR_HALT(ms)         COMM            PID/TID         VCPU_ID    WAIT/POLL  VAILD?    
879542671.234831   59.877982            CPU 2/KVM       269394/269407   2          wait       valid     
879542703.516948   32.138767            CPU 2/KVM       269394/269407   2          wait       valid     
879542759.358528   55.680357            CPU 2/KVM       269394/269407   2          wait       valid     
879542784.405935   74.441939            CPU 1/KVM       529746/529770   1          wait       valid     
879542784.537334   168.631715           CPU 3/KVM       269394/269408   3          wait       valid     
879542787.287187   2.632230             CPU 3/KVM       269394/269408   3          wait       valid     
879542819.265769   31.876126            CPU 3/KVM       269394/269408   3          wait       valid     
879542831.851643   12.209500            CPU 3/KVM       269394/269408   3          wait       valid     
879542843.477238   11.473798            CPU 3/KVM       269394/269408   3          wait       valid     
879542847.407571   3.792108             CPU 3/KVM       269394/269408   3          wait       valid     
879542851.477951   3.966608             CPU 3/KVM       269394/269408   3          wait       valid     
879542855.282047   3.720160             CPU 3/KVM       269394/269408   3          wait       valid     
879542855.806099   96.293315            CPU 2/KVM       269394/269407   2          wait       valid     
879542859.361304   3.961293             CPU 3/KVM       269394/269408   3          wait       valid     
```

### 暂停轮询

```
sudo ./kvm_watcher -n
TIME(ms)           COMM            PID/TID         TYPE       VCPU_ID OLD(ns)     NEW(ns)   
879590230.083646   CPU 0/KVM       529746/529769   grow       0       0       --> 10000 
879590710.510358   CPU 0/KVM       529746/529769   shrink     0       10000   --> 0 
879590991.741948   CPU 4/KVM       269394/269409   grow       4       0       --> 10000 
879591061.851174   CPU 4/KVM       269394/269409   shrink     4       10000   --> 0 
879591831.571142   CPU 3/KVM       269394/269408   grow       3       0       --> 10000 
879591835.425081   CPU 3/KVM       269394/269408   shrink     3       10000   --> 0 
879592213.992940   CPU 0/KVM       529746/529769   grow       0       0       --> 10000 
879592565.028840   CPU 0/KVM       529746/529769   shrink     0       10000   --> 0 
879596214.435717   CPU 0/KVM       529746/529769   grow       0       0       --> 10000 
879596726.128728   CPU 0/KVM       529746/529769   shrink     0       10000   --> 0 
879597907.648862   CPU 3/KVM       269394/269408   grow       3       0       --> 10000 
879597907.837706   CPU 3/KVM       269394/269408   grow       3       10000   --> 20000 
879597935.631756   CPU 3/KVM       269394/269408   shrink     3       20000   --> 0 
879598230.236048   CPU 0/KVM       529746/529769   grow       0       0       --> 10000 
879598567.847044   CPU 0/KVM       529746/529769   shrink     0       10000   --> 0 
879600214.440083   CPU 0/KVM       529746/529769   grow       0       0       --> 10000 
```

### dirty page

```
#sudo ./kvm_watcher -d 
TIME(ms)           COMM            PID/TID         GFN        REL_GFN    NPAGES     USERSPACE_ADDR  SLOT_ID   
1056168589.765210  CPU 2/KVM       630632/630644   f3eeb      3eeb       16384      7fbd5fe00000    3 
1056168589.800763  CPU 2/KVM       630632/630644   f3eec      3eec       16384      7fbd5fe00000    3 
1056168589.837823  CPU 2/KVM       630632/630644   f3eed      3eed       16384      7fbd5fe00000    3 
1056168589.875066  CPU 2/KVM       630632/630644   f3eee      3eee       16384      7fbd5fe00000    3 
1056168589.915464  CPU 2/KVM       630632/630644   f3eef      3eef       16384      7fbd5fe00000    3 
1056168589.953782  CPU 2/KVM       630632/630644   f3ef0      3ef0       16384      7fbd5fe00000    3 
1056168589.988523  CPU 2/KVM       630632/630644   f3ef1      3ef1       16384      7fbd5fe00000    3 
1056168590.025416  CPU 2/KVM       630632/630644   f3ef2      3ef2       16384      7fbd5fe00000    3 
1056168590.063675  CPU 2/KVM       630632/630644   f3ef3      3ef3       16384      7fbd5fe00000    3 
1056168590.357484  CPU 2/KVM       630632/630644   f3efb      3efb       16384      7fbd5fe00000    3 
1056168603.844319  CPU 1/KVM       630632/630643   f3f15      3f15       16384      7fbd5fe00000    3 
1056168605.181247  CPU 1/KVM       630632/630643   f3f16      3f16       16384      7fbd5fe00000    3 
```

脏页次数会按降序保存到临时文件中

```
PID        GFN        REL_GFN    SLOT_ID    COUNTS
630632     f0118      118        3          62
630632     f0119      119        3          62
630632     f011a      11a        3          61
630632     f0127      127        3          61
630632     f0128      128        3          61
630632     f011d      11d        3          61
630632     f011c      11c        3          61
630632     f0120      120        3          61
630632     f0126      126        3          61
630632     f011f      11f        3          61
630632     f011b      11b        3          61
630632     f0123      123        3          61
630632     f0124      124        3          61
630632     f0122      122        3          61
....
```
### load_vcpu

```
sudo ./kvm_watcher -o
TIME:15:23:05
pid          tid          total_time   max_time     min_time     counts       vcpuid       pcpuid      
------------ ------------ ------------ ------------ ------------ ------------ ------------ ------------
49214        49224        1.2344       0.3670       0.0346       9            1            2           
49214        49225        0.5978       0.2171       0.1820       3            2            0           
49062        49072        2.4008       0.2656       0.0806       14           0            4           
49214        49223        4.5310       0.2794       0.0217       66           0            7           
54504        54514        6.9243       0.8872       0.0235       34           1            10          
49145        49166        2.8076       1.1653       0.0689       10           1            9           
54504        54513        3.8860       0.3099       0.0210       30           0            0           
49145        49165        1.4737       0.4106       0.0690       8            0            12
```
## 参数介绍

### dirty page

- **TIME(ms)**: 事件发生的时间，以毫秒为单位。
- **COMM**: 触发脏页产生的进程名称。
- **PID/TID**: 进程或线程的标识符。
- **GFN**: 脏页的客户机页框号（Guest Frame Number）。
- **REL_GFN**: 相对于 GFN 的偏移量。
- **NPAGES**: 内存槽的页面数量。
- **USERSPACE_ADDR**: 触发脏页的用户空间地址。
- **SLOT_ID**: 内存插槽标识，指示哪个内存区域包含了脏页。

### load_vcpu

- **TIME(ms)**: 事件发生的时间，以毫秒为单位。
- **PID/TID**: 进程或线程的标识符。
- **total_time**: 2秒内调度vcpu的总时间。
- **max_time**: 2秒内调度vcpu的最大时间。
- **min_time**: 2秒内调度vcpu的最小时间。
- **counts**: 2秒内调度vcpu的次数。
- **vcpuid**: 虚拟CPU号。
- **pcpuid**: vCPU对应绑定的物理CPU号。