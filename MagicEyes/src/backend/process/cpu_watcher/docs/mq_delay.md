# mq_delay

为了对进程间通过消息队列通信时，发送消息、接手消息以及处于等待状态所用时间进行监测，cpuwatcher工具增添mq_delay工具。

![image_mq](image/image_mq.png)

以上是发送进程发送，接收进程接收的具体过程。本工具通过跟踪单个的消息块（struct msg_msg结构体）来监测发送时延、接收时延以及等待时延。

## 跟踪消息块过程：

发送过程

* 用户程序将要发送的消息通过mq_send()函数或mq_timedsend()函数发送，mq_send/mq_timedsend函数调用mq_timedsend系统调用在内核实现具体的发送实现，此时将指向用户态消息缓冲区的指针u_msg_ptr传入内核态，此处我们第一次追踪到消息块。
* 在mq_timedsend 系统调用中，会调用do_mq_timedsend()内核函数进行发送消息的操作，此处将u_msg_ptr指针作为传参传入do_mq_timedsend()函数；
* 在do_mq_timedsend()函数中，通过load_msg()函数将消息从用户空间加载到内核中，这里将u_msg_ptr指针作为传参；
* load_msg()函数中，通过copy_from_user()函数将u_msg_ptr指针指向的用户空间信息复制到分配的内核空间msg，并返回一个指向消息块所在内核空间的指针msg_ptr，此时我们便在内核中跟踪到了具体的消息块实体，后续操作都是围绕这个消息块指针展开的，包括接收程序也是对此指针进行copy_to_user操作；

接受过程

* 用户程序通过mq_receive()或mq_timedreceive()函数，从消息队列中接收消息，mq_receive()或mq_timedreceive()函数调用mq_timedreceive系统调用在内核中实现具体的接收实现，此时将指向用户态缓冲区的指针u_msg_ptr传入内核，这里是我们本次跟踪最后一次遇到消息块。
* mq_timedreceive系统调用通过do_mq_timedreceive()函数找到要接收的消息块，并将其传入u_msg_ptr所指向的用户空间
* do_mq_timedreceive()函数如果等到要接收的消息块，会通过store_msg()函数将消息块（发送时msg_ptr所指向的消息块）存储至u_msg_ptr所指向的用户空间。所以此时，我们在接收消息的内核处理函数中追踪到了具体的消息块。

此处还可拓展一些功能：

* 对于发送消息块时，是否上等待队列，等待了多久？
* 对于接收消息块时，是否上等待队列，等待了多久？
* 对于处于非阻塞状态的进程，是否可以识别到，并及时统计出来？

## 挂载点：

发送过程：

| 类型      | 名称           |
| --------- | -------------- |
| kprobe    | do_mq_timesend |
| kprobe    | load_msg       |
| kretprobe | load_msg       |
| kretprobe | do_mq_timesend |

接收过程：

| 类型      | 名称              |
| --------- | ----------------- |
| kprobe    | do_mq_timereceive |
| kprobe    | store_msg         |
| kretprobe | store_msg         |
| kretprobe | do_mq_timereceive |

输出效果

```c
Time: 22:12:39
-----------------------------------------------------------------------------------------------------------------------
Mqdes: 3        msg_len: 1152     msg_prio: 50      
SND_PID: 20945    SND_enter_time: 131725037824711  SND_exit_time: 131725037867085 
RCV_PID: 20984    RCV_enter_time: 131726555726321  RCV_exit_time: 131726555872719 
-------------------------------------------------------------------------------
SND_Delay/ms: 0.04      RCV_Delay/ms: 0.15      Delay/ms: 1518.04801
-----------------------------------------------------------------------------------------------------------------------



Time: 22:12:44
-----------------------------------------------------------------------------------------------------------------------
Mqdes: 3        msg_len: 1152     msg_prio: 50      
SND_PID: 21007    SND_enter_time: 131730008219660  SND_exit_time: 131730008614901 
RCV_PID: 21035    RCV_enter_time: 131731465676396  RCV_exit_time: 131731465758821 
-------------------------------------------------------------------------------
SND_Delay/ms: 0.40      RCV_Delay/ms: 0.08      Delay/ms: 1457.53916
-----------------------------------------------------------------------------------------------------------------------



Time: 22:12:48
-----------------------------------------------------------------------------------------------------------------------
Mqdes: 3        msg_len: 1152     msg_prio: 50      
SND_PID: 21069    SND_enter_time: 131733828139276  SND_exit_time: 131733828195905 
RCV_PID: 21098    RCV_enter_time: 131735705540405  RCV_exit_time: 131735705924036 
-------------------------------------------------------------------------------
SND_Delay/ms: 0.06      RCV_Delay/ms: 0.38      Delay/ms: 1877.78476
-----------------------------------------------------------------------------------------------------------------------
```









